<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Tasks Auto Refresh</title>
</head>
<body>
    <h2>Liste des Tâches</h2>
    <ul id="task-list"></ul>

    <script>
        const CLIENT_ID = "407408718192.apps.googleusercontent.com";
        const CLIENT_SECRET = "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";
        const REFRESH_TOKEN = "1//04sf1fYrtJJq8CgYIARAAGAQSNwF-L9Irqd0m6Ft_UKSWNS_AQwAS6OJcMNafcF-k3tbhabdveO-4GwICG_vyMh7a9wAyiTXW-2A";

        // Vérification et renouvellement du token d'accès
        async function refreshAccessToken() {
            console.log("Renouvellement du token...");
            try {
                const response = await fetch("https://oauth2.googleapis.com/token", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                    body: new URLSearchParams({
                        client_id: CLIENT_ID,
                        client_secret: CLIENT_SECRET,
                        refresh_token: REFRESH_TOKEN,
                        grant_type: "refresh_token",
                    }),
                });

                const data = await response.json();
                if (data.access_token) {
                    localStorage.setItem("access_token", data.access_token);
                    console.log("Nouveau token obtenu :", data.access_token);
                    fetchTasks();
                } else {
                    console.error("Erreur lors du renouvellement du token :", data);
                    document.getElementById('task-list').innerHTML = '<li>Erreur lors du renouvellement du token.</li>';
                }
            } catch (error) {
                console.error("Erreur de requête lors du renouvellement :", error);
            }
        }

        // Fonction pour récupérer les tâches avec le token valide
        async function fetchTasks() {
            let token = localStorage.getItem("access_token");

            if (!token) {
                await refreshAccessToken();
                token = localStorage.getItem("access_token");
            }

            try {
                const response = await fetch("https://www.googleapis.com/tasks/v1/lists/@default/tasks", {
                    method: "GET",
                    headers: {
                        Authorization: `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                });

                if (response.status === 401) {
                    console.warn("Token expiré, tentative de renouvellement...");
                    await refreshAccessToken();
                    return;
                }

                const data = await response.json();
                const taskListElement = document.getElementById("task-list");
                taskListElement.innerHTML = '';

                if (data.items && data.items.length > 0) {
                    data.items.forEach(task => {
                        let li = document.createElement("li");
                        li.textContent = task.title;
                        taskListElement.appendChild(li);
                    });
                } else {
                    taskListElement.innerHTML = '<li>Aucune tâche trouvée.</li>';
                }
            } catch (error) {
                console.error("Erreur lors de la récupération des tâches :", error);
                document.getElementById("task-list").innerHTML = '<li>Erreur de récupération des tâches.</li>';
            }
        }

        // Lancement automatique de la récupération des tâches au chargement de la page
        fetchTasks();

        // Rafraîchir le token automatiquement toutes les 55 minutes
        setInterval(refreshAccessToken, 3300000);
    </script>
</body>
</html>
